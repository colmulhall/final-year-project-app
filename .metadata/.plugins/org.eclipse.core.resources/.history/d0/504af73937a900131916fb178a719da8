package com.phoenixpark.app;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import org.apache.http.NameValuePair;
import org.apache.http.message.BasicNameValuePair;
import org.json.JSONArray;
import org.json.JSONObject;

import android.app.Activity;
import android.app.AlertDialog;
import android.app.ProgressDialog;
import android.content.DialogInterface;
import android.content.Intent;
import android.os.AsyncTask;
import android.os.Bundle;
import android.text.format.DateFormat;
import android.view.View;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;

public class EventFeedback extends Activity
{
	private String urlUpload = "http://parkdomain.comoj.com/android_get_users_submission.php";
	private String urlGetInfo = "http://parkdomain.comoj.com/android_get_event_item.php";
	private TextView enterComment, enterRating;
	private EditText editComment;
	private Spinner ratings;
	private Button submit;
	
	// Creating connection handler class instance
	public HandleConnections sh = new HandleConnections();
	public String jsonStr;
	
	JSONArray events;
	JSONObject jObject;
	
    @Override
    public void onCreate(Bundle savedInstanceState) 
    {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.submit_event_layout);
        
        // textviews
        enterComment = (TextView)findViewById(R.id.enter_comment);
        enterRating = (TextView)findViewById(R.id.enter_rating);
        
        // edittext
        editComment = (EditText)findViewById(R.id.comment_enter);
        
        // spinner
        ratings = (Spinner)findViewById(R.id.rating_spin);
        
        //populate the spinner with items in the string array from strings.xml
        String[] ratings_array = getResources().getStringArray(R.array.ratings);
        ArrayAdapter<String> adapter = 
		         new ArrayAdapter<String>
        			(this,android.R.layout.simple_dropdown_item_1line, ratings_array);
        ratings.setAdapter(adapter);
        
        // button
        submit = (Button)findViewById(R.id.submit_button);
        
        submit.setOnClickListener(new View.OnClickListener() 
        {
			public void onClick(View v) 
			{
				new UploadFeedback().execute();
			}
        });
    }
    
    private class UploadFeedback extends AsyncTask<String, Integer, String>
    {
    	private ProgressDialog progress; 
    	
    	@Override
	     protected void onPreExecute() 
	     {
			 super.onPreExecute();
	         // Showing progress dialog
	         progress = ProgressDialog.show(getApplicationContext(), "Giving feedback", "Please Wait...");
	     }
    	
	    @SuppressWarnings("deprecation")
		@Override
	    protected String doInBackground(String... params)
	    {
	    	// get current system date
	    	SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy/MM/dd");
	    	Date newdate = new Date();
	    	
	    	// get the rating from the user
	    	String rate = String.valueOf(ratings.getSelectedItem());
	    	int user_rating;
	    	
	    	// set rating based on the spinner
	    	if(rate.equals("5 Stars"))
	    		user_rating = 5;
	    	else if(rate.equals("4 Stars"))
	    		user_rating = 4;
	    	else if(rate.equals("3 Stars"))
	    		user_rating = 3;
	    	else if(rate.equals("2 Stars"))
	    		user_rating = 2;
	    	else if(rate.equals("1 Stars"))
	    		user_rating = 1;
	    	else
	    		user_rating = 0;
	    	
	    	//get data about the event
	    	//String title = editTitle.getText().toString();
	    	//String desc = editDesc.getText().toString();
	    	//String location = editLocation.getText().toString();
	    	String date = dateFormat.format(date);
	    	//String commment = editCategory.getText().toString();
	    	String star_rating = ""+user_rating;
	    	
	    	
	        // Send the users entered parameters to the PHP script through POST
			List<NameValuePair> nameValuePairs = new ArrayList<NameValuePair>();
			nameValuePairs.add(new BasicNameValuePair("title", title));
			nameValuePairs.add(new BasicNameValuePair("description", desc));
			nameValuePairs.add(new BasicNameValuePair("date", date));
			nameValuePairs.add(new BasicNameValuePair("location", location));
			nameValuePairs.add(new BasicNameValuePair("category", comment));
			nameValuePairs.add(new BasicNameValuePair("contact_link", star_rating));
			
			jsonStr = sh.makeServiceCall(url, HandleConnections.POST, nameValuePairs);
			return jsonStr;
	    }
	    
	    @Override
	    protected void onPostExecute(String result) 
	    {
	    	progress.dismiss();
	        // process the result
	        super.onPostExecute(result);
	        finish(); 

	        Toast.makeText(getApplicationContext(), "Event submitted", Toast.LENGTH_SHORT).show();
	    }
    }
    
    // back button pressed by user
    @Override
    public void onBackPressed() 
    {
        finish();//go back to the previous Activity
        overridePendingTransition(R.anim.slideup_in, R.anim.slideup_out);   
    }
}